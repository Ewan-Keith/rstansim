<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using rstansim to run a simulation study • rstansim</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">rstansim</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    How to
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://ewan-keith.github.io/rstansim/articles/using-rstansim.html">Example Study with rstansim</a>
    </li>
    <li>
      <a href="https://ewan-keith.github.io/rstansim/articles/simulating_data.html">Simulating data</a>
    </li>
    <li>
      <a href="https://ewan-keith.github.io/rstansim/articles/model-fitting.html">Model fitting and capture of relevant data</a>
    </li>
    <li>
      <a href="https://ewan-keith.github.io/rstansim/articles/managing-results.html">Managing simulation results</a>
    </li>
    <li>
      <a href="https://ewan-keith.github.io/rstansim/articles/reproducability.html">A note on reproducability</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    news
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    functions
  </a>
</li>
<li>
  <a href="https://github.com/Ewan-Keith/rstansim">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Using rstansim to run a simulation study</h1>
                        <h4 class="author">Ewan Keith</h4>
            
            <h4 class="date">2017-09-03</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This document gives an end to end example of using the rstansim package to carry out a small simulation study using stan. It’s recommended as a first point of call to understand how the package works, but does not provided detailed documentation of all functionality.</p>
<p>After reading through this example, the below documents can provide further detailed documentation on specific elements:</p>
<ul>
<li>Simulating data using rstansim. [ADD LINK]</li>
<li>
<a href="model-fitting.html">Fitting models using rstansim</a>.</li>
<li>Managing results using rstansim. [ADD LINK]</li>
</ul>
<p>Beyond that function documentation can be found here. [ADD LINK]</p>
<div id="the-study-question" class="section level3">
<h3 class="hasAnchor">
<a href="#the-study-question" class="anchor"></a>The study question</h3>
<p>Any simulation study needs to start with a question about the behaviour of certain models/estimators under specific conditions. In this case, our question comes straight from the stan manual.</p>
<p>In the section on regression models, the first example of a multiple regression model in stan is a straightforward vectorised implementation, shown below.</p>
<pre class="stan"><code>// saved as simple_reg_model.stan
data {
  int&lt;lower=0&gt; N; // number of data items
  int&lt;lower=0&gt; K; // number of predictors
  matrix[N, K] x; // predictor matrix
  vector[N] y; // outcome vector
}
parameters {
  real alpha; // intercept
  vector[K] beta; // coefficients for predictors
  real&lt;lower=0&gt; sigma; // error scale
}
model {
  y ~ normal(x * beta + alpha, sigma); // likelihood
}</code></pre>
<p>However immediately after this is introduced another way to format a multiple regression, named the QR Reparameterization, is introduced. Again this is shown below.</p>
<pre class="stan"><code>// saved as qr_reg_model.stan
data {
  int&lt;lower=0&gt; N; // number of data items
  int&lt;lower=0&gt; K; // number of predictors
  matrix[N, K] x; // predictor matrix
  vector[N] y; // outcome vector
}
transformed data {
  matrix[N, K] Q_ast;
  matrix[K, K] R_ast;
  matrix[K, K] R_ast_inverse;
  // thin and scale the QR decomposition
  Q_ast = qr_Q(x)[, 1:K] * sqrt(N - 1);
  R_ast = qr_R(x)[1:K, ] / sqrt(N - 1);
  R_ast_inverse = inverse(R_ast);
}
parameters {
  real alpha; // intercept
  vector[K] theta; // coefficients on Q_ast
  real&lt;lower=0&gt; sigma; // error scale
}
model {
  y ~ normal(Q_ast * theta + alpha, sigma); // likelihood
}
generated quantities {
  vector[K] beta;
  beta = R_ast_inverse * theta; // coefficients on x
}</code></pre>
<p>The stan manual provides more detail on the derivation of the QR parameterization, and the reasons for it’s efficiency. In short the reasons given to use the QR model are that it:</p>
<ol style="list-style-type: decimal">
<li>Gives equivalent posterior parameter estimates to the original model</li>
<li>Can decrease the total elapsed time to fit a model.</li>
<li>Can improve the effective sample size (ESS) for sampled parameter chains.</li>
</ol>
<p>This small simulation study will explore the above three advantages to see if they hold in the case of small to medium predictor correlations, and to assess the magnitude of any observed differences between the two models.</p>
</div>
</div>
<div id="simulating-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-the-data" class="anchor"></a>Simulating the data</h2>
<p>In order to test our above hypotheses we’ll be simulating data two generative models. The models only differ in their parameter values and so can both be simulaetd using a single stan model (if there were structural differences then they would require different models).</p>
<p>One of the advantages of using rstansim to generate data for a simulation study is that it lets you use a stan model to specify the data, this gives you a huge degree of flexibility in how the simulated data will look, and can even let you draw your posterior samples using the same code that generated your data. For clarity here though we’ve generated a small stan model purely for the purposes of generating our simulated data, it’s shown below.</p>
<pre class="stan"><code>// saved as sim_data_model.stan
data {
  int&lt;lower=0&gt; N; // number of data items
  int&lt;lower=0&gt; K; // number of predictors
}
parameters {
  real alpha; // intercept
  vector[K] beta; // coefficients for predictors
  real&lt;lower=0&gt; sigma; // error scale
  corr_matrix[K] omega;
}
transformed parameters{
  cov_matrix[K] cov_omega;

  cov_omega = quad_form_diag(omega, rep_vector(1, K));
}
generated quantities {
  matrix[N, K] sim_x; // simulated predictor data
  vector[N] sim_y; // simulated outcome vector

  for(i in 1:N) sim_x[i,] = multi_normal_rng(rep_vector(0, K), cov_omega)';
  for(i in 1:N) sim_y[i] = normal_rng(alpha + sim_x[i] * beta, sigma)';
}</code></pre>
<p>This model is cut down to only be used for simulating the desired data. The important points to note are:</p>
<ol style="list-style-type: decimal">
<li>Any data or parameters that you wish to vary in order to produce different simulated datasets are entered in the <code>data</code> or <code>parameter</code> blocks, as with a typical stan model.</li>
<li>All variables to be simulated are specified in the <code>generated quantities</code> block, using stan’s built in random number generators.</li>
<li>Note that the simulated variables have their names prepended with <code>sim_</code>, this is good practice to differentiate simulated quantities in the model from user provided values. By default this <code>sim_</code> will be dropped from the saved dataset so that the data can easily be used as model input (e.g. <code>sim_x</code> becomes just <code>x</code>).</li>
</ol>
<p>The <code><a href="../reference/simulate_data.html">simulate_data()</a></code> function can take this model, along with data and parameter values to use, and use them to simulate multiple datasets containing the relevant data. When called <code><a href="../reference/simulate_data.html">simulate_data()</a></code> has two effects; it saves all simulated datasets to a specified directory, and it returns an object of class <code>stansim_data</code> which acts as a ‘ticket’ for the saved datasets; providing summary information and able to be fed directly in to the <code><a href="../reference/fit_models.html">fit_models()</a></code> function below, simplifying the workflow.</p>
<p>For the purposes of our simulation we want to simulate 100 datasets, 50 of which will have uncorrelated <code>x</code> columns, and 50 of which will have correlations varying between 0 and 0.4. It’s expected that the benefits of the QR model will be greater for the correlated predictors datasets. The input data and parameters for these are specified below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set up independent covariance matrix</span>
omega_uncorr &lt;-<span class="st"> </span><span class="kw">diag</span>(<span class="dv">5</span>)
omega_uncorr
##      [,1] [,2] [,3] [,4] [,5]
## [1,]    1    0    0    0    0
## [2,]    0    1    0    0    0
## [3,]    0    0    1    0    0
## [4,]    0    0    0    1    0
## [5,]    0    0    0    0    1

<span class="co"># set up correlated covariance matrix</span>
omega_corr &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, .<span class="dv">2</span>, .<span class="dv">3</span>, .<span class="dv">4</span>),
                           <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">3</span>, .<span class="dv">4</span>, .<span class="dv">2</span>),
                           <span class="kw">c</span>(.<span class="dv">2</span>, .<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">0</span>, .<span class="dv">4</span>), 
                           <span class="kw">c</span>(.<span class="dv">3</span>, .<span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">2</span>), 
                           <span class="kw">c</span>(.<span class="dv">4</span>, .<span class="dv">2</span>, .<span class="dv">4</span>, .<span class="dv">2</span>, <span class="dv">1</span>)), <span class="dv">5</span>, <span class="dv">5</span>)
omega_corr
##      [,1] [,2] [,3] [,4] [,5]
## [1,]  1.0  0.0  0.2  0.3  0.4
## [2,]  0.0  1.0  0.3  0.4  0.2
## [3,]  0.2  0.3  1.0  0.0  0.4
## [4,]  0.3  0.4  0.0  1.0  0.2
## [5,]  0.4  0.2  0.4  0.2  1.0

regression_input_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">"N"</span> =<span class="st"> </span><span class="dv">1000</span>, <span class="st">"K"</span> =<span class="st"> </span><span class="dv">5</span>)

regression_uncorr_params &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">"alpha"</span> =<span class="st"> </span><span class="dv">5</span>, <span class="st">"beta"</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, .<span class="dv">8</span>, .<span class="dv">6</span>, .<span class="dv">4</span>),
                                 <span class="st">"sigma"</span> =<span class="st"> </span><span class="dv">1</span>, <span class="st">"omega"</span> =<span class="st"> </span>omega_uncorr)

regression_corr_params &lt;-<span class="kw">list</span>(<span class="st">"alpha"</span> =<span class="st"> </span><span class="dv">5</span>, <span class="st">"beta"</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, .<span class="dv">8</span>, .<span class="dv">6</span>, .<span class="dv">4</span>),
                              <span class="st">"sigma"</span> =<span class="st"> </span><span class="dv">1</span>, <span class="st">"omega"</span> =<span class="st"> </span>omega_corr)</code></pre></div>
<p>With our input values set up we can now simulate data easily.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rstansim)

<span class="co"># simulate data with uncorrelated predictors</span>
uncorrelated_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simulate_data.html">simulate_data</a></span>(
  <span class="dt">file =</span> <span class="st">"sim_data_model.stan"</span>,
  <span class="dt">data_name =</span> <span class="st">"uncorrelated multi-regression"</span>,
  <span class="dt">input_data =</span> regression_input_data,
  <span class="dt">param_values =</span> regression_uncorr_params,
  <span class="dt">vars =</span> <span class="kw">c</span>(<span class="st">"N"</span>, <span class="st">"K"</span>, <span class="st">"sim_x"</span>, <span class="st">"sim_y"</span>),
  <span class="dt">nsim =</span> <span class="dv">50</span>,
  <span class="dt">path =</span> <span class="st">"reg_data/uncorrelated"</span>
  )

<span class="co"># simulate data with correlated predictors</span>
correlated_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simulate_data.html">simulate_data</a></span>(
  <span class="dt">file =</span> <span class="st">"sim_data_model.stan"</span>,
  <span class="dt">data_name =</span> <span class="st">"correlated multi-regression"</span>,
  <span class="dt">input_data =</span> regression_input_data,
  <span class="dt">param_values =</span> regression_corr_params, 
  <span class="dt">vars =</span> <span class="kw">c</span>(<span class="st">"N"</span>, <span class="st">"K"</span>, <span class="st">"sim_x"</span>, <span class="st">"sim_y"</span>),
  <span class="dt">nsim =</span> <span class="dv">50</span>,
  <span class="dt">path =</span> <span class="st">"reg_data/correlated"</span>
  )</code></pre></div>
<p>Looking in our working directory shows that the specified folders have been created and filled with our simulated datasets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># see folders inside reg_data/</span>
<span class="kw">dir</span>(<span class="st">"reg_data"</span>)
## [1] "correlated"   "uncorrelated"

<span class="co"># see first five files in reg_data/correlated/</span>
<span class="kw">dir</span>(<span class="st">"reg_data/correlated"</span>)[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>]
## [1] "correlated multi-regression_10.rds"
## [2] "correlated multi-regression_11.rds"
## [3] "correlated multi-regression_12.rds"
## [4] "correlated multi-regression_13.rds"
## [5] "correlated multi-regression_14.rds"</code></pre></div>
<p>For a quick check that things have run as expected we’ll take a look at a given simuldated data file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">readRDS</span>(<span class="st">"reg_data/correlated/correlated multi-regression_1.rds"</span>))
## List of 4
##  $ N: num 1000
##  $ K: num 5
##  $ x: num [1:1000, 1:5] 1.862 0.266 0.622 0.537 -1.712 ...
##  $ y: num [1:1000(1d)] 4.02 3.75 7.41 5.63 7.62 ...</code></pre></div>
</div>
<div id="fitting-the-models" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-models" class="anchor"></a>Fitting the models</h2>
<p>It’s good practice to check that the simulated data returns sensible parameter estimates when fitted to a single model before investing the time and resources into fitting models to every dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># set the number of available cores to use</span>
<span class="co"># core_num &lt;- parallel::detectCores() - 1</span>

test_data &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">"reg_data/uncorrelated/uncorrelated multi-regression_1.rds"</span>)

test_fit &lt;-<span class="st"> </span>rstan<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/rstan/topics/stan">stan</a></span>(<span class="dt">file =</span> <span class="st">"simple_reg_model.stan"</span>, <span class="dt">data =</span> test_data)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rstan<span class="op">::</span><span class="kw">summary</span>(test_fit)<span class="op">$</span>summary
##                  mean      se_mean         sd          2.5%           25%
## alpha      4.99489977 0.0005395435 0.03412373    4.92920567  4.971334e+00
## beta[1]   -0.01952893 0.0005124118 0.03240777   -0.08377418 -4.129069e-02
## beta[2]    0.02026169 0.0004922474 0.03113246   -0.04135261 -6.590125e-04
## beta[3]    0.81678169 0.0005248994 0.03319755    0.75154412  7.946678e-01
## beta[4]    0.65404834 0.0005176178 0.03273702    0.58873181  6.324120e-01
## beta[5]    0.33323066 0.0005242772 0.03315820    0.26927704  3.111978e-01
## sigma      1.01571925 0.0003782558 0.02392300    0.97081393  9.987825e-01
## lp__    -514.72602050 0.0430250965 1.97524670 -519.43564845 -5.158141e+02
##                   50%           75%         97.5%    n_eff      Rhat
## alpha      4.99453158  5.018427e+00    5.06124332 4000.000 0.9996185
## beta[1]   -0.01935526  1.831165e-03    0.04506135 4000.000 0.9997551
## beta[2]    0.01971286  4.263707e-02    0.07910599 4000.000 0.9999570
## beta[3]    0.81681151  8.390760e-01    0.88140469 4000.000 0.9996494
## beta[4]    0.65417415  6.753296e-01    0.71971028 4000.000 0.9998779
## beta[5]    0.33356382  3.559752e-01    0.39783862 4000.000 0.9996908
## sigma      1.01532359  1.032192e+00    1.06288225 4000.000 0.9996206
## lp__    -514.37873713 -5.132996e+02 -511.93078856 2107.652 1.0020570</code></pre></div>
<p>These values are all in the region we’d expect. The <code><a href="../reference/fit_models.html">fit_models()</a></code> function is used to fit a given stan model to multiple datasets, we can use the <code>stansim_data</code> object produced above as input pointing to our simulated datasets. Our study questions has a 2x2 design so fit_models needs called 4 times.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># fit simple model to uncorrelated data</span>
stansim_output1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_models.html">fit_models</a></span>(<span class="dt">sim_name =</span> <span class="st">"simple - uncorrelated simulation"</span>,
                              <span class="dt">sim_data =</span> uncorrelated_data,
                              <span class="dt">stan_args =</span> <span class="kw">list</span>(<span class="dt">file =</span> <span class="st">"simple_reg_model.stan"</span>))

<span class="co"># fit simple model to correlated data</span>
stansim_output2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_models.html">fit_models</a></span>(<span class="dt">sim_name =</span> <span class="st">"simple - correlated simulation"</span>,
                              <span class="dt">sim_data =</span> correlated_data,
                              <span class="dt">stan_args =</span> <span class="kw">list</span>(<span class="dt">file =</span> <span class="st">"simple_reg_model.stan"</span>))

<span class="co"># fit QR model to uncorrelated data</span>
stansim_output3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_models.html">fit_models</a></span>(<span class="dt">sim_name =</span> <span class="st">"QR - uncorrelated simulation"</span>,
                              <span class="dt">sim_data =</span> uncorrelated_data,
                              <span class="dt">stan_args =</span> <span class="kw">list</span>(<span class="dt">file =</span> <span class="st">"qr_reg_model.stan"</span>))

<span class="co"># fit QR model to correlated data</span>
stansim_output4 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_models.html">fit_models</a></span>(<span class="dt">sim_name =</span> <span class="st">"QR - correlated simulation"</span>,
                              <span class="dt">sim_data =</span> correlated_data,
                              <span class="dt">stan_args =</span> <span class="kw">list</span>(<span class="dt">file =</span> <span class="st">"qr_reg_model.stan"</span>))</code></pre></div>
</div>
<div id="collecting-the-results" class="section level2">
<h2 class="hasAnchor">
<a href="#collecting-the-results" class="anchor"></a>Collecting the results</h2>
<p>Given that a realistic simulation study may have many combinations of model and data to fit, it’s likely that a large number of simulation objects will be created. To ease the analysis of results (and to make storage simpler) it’s recommended that you collect these objects into one. All data held by the individual objects is retained.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">reg_study_col &lt;-<span class="st"> </span><span class="kw"><a href="../reference/collect_simulations.html">collect_simulations</a></span>(
  <span class="dt">collection_name =</span> <span class="st">"regression study collection"</span>,
  stansim_output1,
  stansim_output2,
  stansim_output3,
  stansim_output4)</code></pre></div>
</div>
<div id="analysing-results" class="section level2">
<h2 class="hasAnchor">
<a href="#analysing-results" class="anchor"></a>Analysing results</h2>
<p>Now that our simulations have been ran and collected we can easily explore the data across all models and datasets. A good first check is that no datasets have an R-hat value greater than 1.1 (a necessary but not sufficient condition for convergence).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/extract_data.html">extract_data</a></span>(
  reg_study_col,
  <span class="dt">estimates =</span> <span class="st">"Rhat"</span>,
  <span class="dt">values =</span> <span class="cf">function</span>(x)
  x <span class="op">&gt;</span><span class="st"> </span><span class="fl">1.1</span>
  )
## [1] sim_name  dataset   parameter estimate  value    
## &lt;0 rows&gt; (or 0-length row.names)</code></pre></div>
<p>This is a good first sign and suggests that our models have converged.</p>
<p>The first of the hypotheses to be tested is that the simple regression model and the QR reparamatization produce equivalent parameter estimates. This is checked for both datasets below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># extract estimates for correlated datasets</span>
correlated_beta_estimates &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_data.html">extract_data</a></span>(
  reg_study_col,
  <span class="dt">sim_names =</span> <span class="kw">c</span>(<span class="st">"QR - correlated simulation"</span>, <span class="st">"simple - correlated simulation"</span>), 
  <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="st">"beta"</span>), 
  <span class="dt">estimates =</span> <span class="st">"mean"</span>)

<span class="co"># extract estimates for uncorrelated datasets</span>
uncorrelated_beta_estimates &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_data.html">extract_data</a></span>(
  reg_study_col,
  <span class="dt">sim_names =</span> <span class="kw">c</span>(<span class="st">"QR - uncorrelated simulation"</span>, <span class="st">"simple - uncorrelated simulation"</span>), 
  <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="st">"beta"</span>), 
  <span class="dt">estimates =</span> <span class="st">"mean"</span>)

<span class="co"># plot beta estimates for correlated datasets</span>
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(ggjoy)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(correlated_beta_estimates, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>value, <span class="dt">y =</span> parameter)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggjoy/topics/geom_joy">geom_joy</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>sim_name)</code></pre></div>
<p><img src="using-rstansim_files/figure-html/unnamed-chunk-14-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># plot beta estimates for uncorrelated datasets</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(uncorrelated_beta_estimates, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>value, <span class="dt">y =</span> parameter)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggjoy/topics/geom_joy">geom_joy</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>sim_name)</code></pre></div>
<p><img src="using-rstansim_files/figure-html/unnamed-chunk-14-2.png" width="672"></p>
<p>We can see that the mean beta estimates are essentially identical over the two models, for both correlated values predictor variables and uncorrelated. In practice, you would want to run similar analysis across all parameters and estimates of relevance. Tail quantiles for example are less robust than mean estimates and so might show differences in chain behaviour that the above charts do not.</p>
<p>The second hypothesis concerned the total time taken to fit a model, at a very high level we can check this by extracting the total time taken to carry out each <code><a href="../reference/fit_models.html">fit_models()</a></code> call. Elapsed run times can be extracted from simulation or collection objects with <code><a href="../reference/extract_time_elapsed.html">extract_time_elapsed()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># extract total times (warmup and sampling) for correlated datasets</span>
correlated_time &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_time_elapsed.html">extract_time_elapsed</a></span>(
  reg_study_col,
  <span class="dt">sim_names =</span> <span class="kw">c</span>(<span class="st">"QR - correlated simulation"</span>, 
                <span class="st">"simple - correlated simulation"</span>),
  <span class="dt">stages =</span> <span class="st">"total"</span>
  )
  
<span class="co"># extract total times (warmup and sampling) for correlated datasets</span>
uncorrelated_time &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_time_elapsed.html">extract_time_elapsed</a></span>(
  reg_study_col,
  <span class="dt">sim_names =</span> <span class="kw">c</span>(<span class="st">"QR - uncorrelated simulation"</span>,
                <span class="st">"simple - uncorrelated simulation"</span>),
  <span class="dt">stages =</span> <span class="st">"total"</span>
  )

<span class="co"># plot total elapsed time for correlated datasets</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(correlated_time, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>elapsed, <span class="dt">y =</span> sim_name)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggjoy/topics/geom_joy">geom_joy</a></span>()</code></pre></div>
<p><img src="using-rstansim_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># plot total elapsed time for uncorrelated datasets</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(uncorrelated_time, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>elapsed, <span class="dt">y =</span> sim_name)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggjoy/topics/geom_joy">geom_joy</a></span>()</code></pre></div>
<p><img src="using-rstansim_files/figure-html/unnamed-chunk-15-2.png" width="672"></p>
<p>When concerned with total run time, QR models tended to perform slightly quicker than the simple model when predictor variables were correlated, and slightly slower in cases where the predictors were uncorrelated. In both cases the QR model had a longer right tail, showing slightly less stability in the total time taken to fit the models.</p>
<p>Total time taken can be misleading when dealing with MCMC samples as it doesn’t capture the amount of sampling information captured, which can vary a lot from model to model. It’s easy to extract the number of effective samples for all four fitted models and compare them by parameter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># extract the effective number of parameters samples for correlated datasets</span>
n_eff_correlated &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_data.html">extract_data</a></span>(reg_study_col,
  <span class="dt">sim_names =</span> <span class="kw">c</span>(<span class="st">"QR - correlated simulation"</span>, <span class="st">"simple - correlated simulation"</span>), 
  <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>, <span class="st">"lp__"</span>),
  <span class="dt">estimates =</span> <span class="st">"n_eff"</span>)

<span class="co"># extract the effective number of parameters samples for uncorrelated datasets</span>
n_eff_uncorrelated &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_data.html">extract_data</a></span>(reg_study_col,
  <span class="dt">sim_names =</span> <span class="kw">c</span>(<span class="st">"QR - uncorrelated simulation"</span>, <span class="st">"simple - uncorrelated simulation"</span>),
  <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="st">"beta"</span>, <span class="st">"sigma"</span>, <span class="st">"lp__"</span>),
  <span class="dt">estimates =</span> <span class="st">"n_eff"</span>)

<span class="co"># plot correlated datasets effective samples by parameter</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(n_eff_correlated, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> value, <span class="dt">y =</span> sim_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_jitter">geom_jitter</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>parameter)</code></pre></div>
<p><img src="using-rstansim_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># plot uncorrelated datasets effective samples by parameter</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(n_eff_uncorrelated, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> value, <span class="dt">y =</span> sim_name)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_jitter">geom_jitter</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>parameter)</code></pre></div>
<p><img src="using-rstansim_files/figure-html/unnamed-chunk-16-2.png" width="672"></p>
<p>The results are close to identical for both models, with all shared parameters showing a near perfect 4000 effective samples per model (4 chains * 1000 samples) with the exception of the log posterior. The only noticable difference between models is a very slightly higher number of effective samples of the log posterior for the QR model when fitting to datasets with correlated predictor variables.</p>
</div>
<div id="conclusions" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h2>
<p>The data and models used here are intended primarily as an example of rstansim functionality, not as a rigourous exploration of the QR decomposition approach to Bayesian regression. Such a study would explore a wider range of conditions, especially higher correlations between predictor variable <a href="http://mc-stan.org/users/documentation/case-studies/qr_regression.html">where the difference between the straightforward and QR models becomes very apparent</a>. But at a minimum these results show that the QR regression is not necessary for good sampling behaviour when the sample size is high (N = 1000) and the predictor correlations small (&lt; .4).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#simulating-the-data">Simulating the data</a></li>
      <li><a href="#fitting-the-models">Fitting the models</a></li>
      <li><a href="#collecting-the-results">Collecting the results</a></li>
      <li><a href="#analysing-results">Analysing results</a></li>
      <li><a href="#conclusions">Conclusions</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ewan Keith.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
